module.exports=function(t){var e={};function r(o){if(e[o])return e[o].exports;var s=e[o]={i:o,l:!1,exports:{}};return t[o].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=t,r.c=e,r.d=function(t,e,o){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)r.d(o,s,function(e){return t[e]}.bind(null,s));return o},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=4)}([function(t,e,r){"use strict";e.__esModule=!0;e.localPosition={mini:[62,75,24,25],max:[14,0,72,100],hide:[-5,-5,1,1]},e.template={"1+3":[{position:[14,0,72,75],seat:1,status:"pull",roster:{},playUrl:""},{position:[38,75,24,25],seat:2,status:"pull",roster:{},playUrl:""},{position:[14,75,24,25],seat:3,status:"pull",roster:{},playUrl:""}]},e.initHidePosition=[-5,-5,0,0],e.hidePosition=[30,90,1,1]},function(t,e){t.exports=require("clone-deep")},function(t,e,r){"use strict";(function(t){var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t){var r,o=Object.prototype,s=o.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(t,e,r,o){var s=e&&e.prototype instanceof m?e:m,n=Object.create(s.prototype),i=new P(o||[]);return n._invoke=function(t,e,r){var o=l;return function(s,n){if(o===g)throw new Error("Generator is already running");if(o===f){if("throw"===s)throw n;return R()}for(r.method=s,r.arg=n;;){var i=r.delegate;if(i){var a=k(i,r);if(a){if(a===p)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===l)throw o=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=g;var c=h(t,e,r);if("normal"===c.type){if(o=r.done?f:d,c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=f,r.method="throw",r.arg=c.arg)}}}(t,r,i),n}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=u;var l="suspendedStart",d="suspendedYield",g="executing",f="completed",p={};function m(){}function v(){}function y(){}var S={};S[i]=function(){return this};var w=Object.getPrototypeOf,I=w&&w(w(N([])));I&&I!==o&&s.call(I,i)&&(S=I);var b=y.prototype=m.prototype=Object.create(S);function x(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function T(t){var r;this._invoke=function(o,n){function i(){return new Promise(function(r,i){!function r(o,n,i,a){var c=h(t[o],t,n);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"===(void 0===l?"undefined":e(l))&&s.call(l,"__await")?Promise.resolve(l.__await).then(function(t){r("next",t,i,a)},function(t){r("throw",t,i,a)}):Promise.resolve(l).then(function(t){u.value=t,i(u)},function(t){return r("throw",t,i,a)})}a(c.arg)}(o,n,r,i)})}return r=r?r.then(i,i):i()}}function k(t,e){var o=t.iterator[e.method];if(o===r){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=r,k(t,e),"throw"===e.method))return p;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var s=h(o,t.iterator,e.arg);if("throw"===s.type)return e.method="throw",e.arg=s.arg,e.delegate=null,p;var n=s.arg;return n?n.done?(e[t.resultName]=n.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=r),e.delegate=null,p):n:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,p)}function C(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function M(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function P(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(C,this),this.reset(!0)}function N(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,n=function e(){for(;++o<t.length;)if(s.call(t,o))return e.value=t[o],e.done=!1,e;return e.value=r,e.done=!0,e};return n.next=n}}return{next:R}}function R(){return{value:r,done:!0}}v.prototype=b.constructor=y,y.constructor=v,y[c]=v.displayName="GeneratorFunction",t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===v||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,y):(t.__proto__=y,c in t||(t[c]="GeneratorFunction")),t.prototype=Object.create(b),t},t.awrap=function(t){return{__await:t}},x(T.prototype),T.prototype[a]=function(){return this},t.AsyncIterator=T,t.async=function(e,r,o,s){var n=new T(u(e,r,o,s));return t.isGeneratorFunction(r)?n:n.next().then(function(t){return t.done?t.value:n.next()})},x(b),b[c]="Generator",b[i]=function(){return this},b.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var o=e.pop();if(o in t)return r.value=o,r.done=!1,r}return r.done=!0,r}},t.values=N,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(M),!t)for(var e in this)"t"===e.charAt(0)&&s.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=r)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function o(o,s){return a.type="throw",a.arg=t,e.next=o,s&&(e.method="next",e.arg=r),!!s}for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n],a=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=s.call(i,"catchLoc"),u=s.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&s.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var n=o;break}}n&&("break"===t||"continue"===t)&&n.tryLoc<=e&&e<=n.finallyLoc&&(n=null);var i=n?n.completion:{};return i.type=t,i.arg=e,n?(this.method="next",this.next=n.finallyLoc,p):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),M(r),p}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var o=r.completion;if("throw"===o.type){var s=o.arg;M(r)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,o){return this.delegate={iterator:N(t),resultName:e,nextLoc:o},"next"===this.method&&(this.arg=r),p}}}("object"===e(t)?t.exports:{})}).call(this,r(5)(t))},function(t,e,r){"use strict";e.__esModule=!0;var o=function(){function t(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.initLoggerInfo(),this.isLogger=r,this.isConsole=e,this.isInit=o}return t.prototype.initLoggerInfo=function(){this.systemInfo=wx.getSystemInfoSync(),this.logger=wx.getLogManager(1),this.isInit&&this.logger.log("Init system info: ",this.systemInfo,"info")},t.prototype.setDebug=function(t,e){this.isConsole=t,this.isLogger=e},t.prototype.log=function(){for(var t,e,r,o,s,n,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"info",u=arguments.length,h=Array(u>3?u-3:0),l=3;l<u;l++)h[l-3]=arguments[l];this.isConsole&&(n=console).log.apply(n,[i,a].concat(h));if(this.isLogger)switch(c){case"info":(t=this.logger).info.apply(t,[i,a].concat(h));break;case"log":(e=this.logger).log.apply(e,[i,a].concat(h));break;case"warn":(r=this.logger).warn.apply(r,[i,a].concat(h));break;case"debug":(o=this.logger).debug.apply(o,[i,a].concat(h));break;default:(s=this.logger).log.apply(s,[i,a].concat(h))}},t}();e.default=o},function(t,e,r){"use strict";var o=g(r(1)),s=g(r(2)),n=g(r(3)),i=r(6),a=r(7),c=g(r(8)),u=g(r(9)),h=r(10),l=r(11),d=r(0);function g(t){return t&&t.__esModule?t:{default:t}}Component({behaviors:[a.computedBehavior],properties:{beauty:{type:Number,value:5},muted:{type:Boolean,value:!1,observer:function(){this.onSwitchAudioMute()}},camera:{type:Boolean,value:!0,observer:function(){this.onSwitchVideoMute()}},devicePosition:{type:String,value:"front"},waitingImage:{type:String,value:"https://devcdn.xylink.com/miniProgram/bg-6.png"},template:{type:Object,value:{layout:"auto",mode:"3-1",detail:[]},observer:function(t){var e=this,r=t?t.detail:[];this.logger.log("<info> template change value: ",t),setTimeout(function(){e.onCreateCustomLayout(r)},5)}}},data:{display:!1,mute:"unmute",disableMute:!1,pushUrl:"",displayName:"",avatar:"https://devcdn.xylink.com/miniProgram/photo_default.png",mode:"1+3",screen:(0,o.default)(d.template["1+3"]),localScreen:d.localPosition.max,customScreen:[],isNullPerson:!0,onHold:!1},computed:{muteStatus:function(){return this.data.muted},show:function(){return this.data.display?"xy-room":"xy-room xy-hide"},isMaxVideo:function(){return"xy-video xy-mini xy-1 "+(this.data.isNullPerson?"xy-big-bang":"")},newCustomScreen:function(){var t=this,e=this.data.customScreen.map(function(e){var r=e.position,o="left: "+r[0]+"vw; top: "+r[1]+"vh; width: "+r[2]+"vw; height: "+r[3]+"vh",s=e.callNumber===t.userInfo.callNumber,n=e.name.split("");n.length>=9&&(n.length=8,n.push("..."));var i=n.map(function(t,r){return{i:e.callNumber+r+t,name:t}}),a="pause";e.roster&&e.roster.userId&&(a=!e.roster.videoTxMute&&e.playUrl?"start":"pause");var c="0";return e&&e.roster&&e.roster.isContent&&(c=e.roster.isContent?"1":"0"),Object.assign({},e,{displayName:i,style:o,isPusher:s,pullStatus:a,mediaGroupId:c})});return e},newScreen:function(){var t=this,e=this.data.screen.map(function(e){if(!e.roster.userId)return e;var r=e.roster.displayName.split("");1===e.seat?r.length>=16&&(r.length=15,r.push("...")):r.length>=9&&(r.length=8,r.push("..."));var o=r.map(function(t,r){return{i:e.roster.userId+r+t,name:t}}),s=d.template[t.data.mode].length,n=e.seat>1&&e.seat<=s?"video-mini":"",i=t.data.onHold?"left: "+e.hidePosition[0]+"vw;\n          top: "+e.hidePosition[1]+"vh;\n          width: "+e.hidePosition[2]+"vw;\n          height: "+e.hidePosition[3]+"vh;\n        ":" left: "+e.position[0]+"vw;\n          top: "+e.position[1]+"vh;\n          width: "+e.position[2]+"vw;\n          height: "+e.position[3]+"vh;\n        ";i=t.content.userId&&e.roster.isActiveSpeaker?i.concat("border: 2px solid #44b5ff; box-sizing: border-box;"):i.concat("border: none; box-sizing: border-box;");var a="";a=!e.roster.videoTxMute&&e.playUrl&&"start"===e.status?"start":e.roster.videoTxMute||"pull"!==e.status&&e.playUrl?"pause":"pull";var c=e.roster.isContent?"contain":"fillCrop",u=e.roster.isContent?"1":"0",h=!!e.roster.muted;return Object.assign({},e,{displayName:o,debug:1===e.seat&&t.debug,newClass:"video "+n,pullStatus:a,style:i,fit:c,muted:h,mediaGroupId:u})});return e},onholdStyle:function(){return this.data.onHold?"position: fixed;":""},localVideo:function(){return this.data.onHold?" left: "+d.hidePosition[0]+"vw;\n        top: "+d.hidePosition[1]+"vh;\n        width: "+d.hidePosition[2]+"vw; \n        height: "+d.hidePosition[3]+"vh;\n      ":" left: "+this.data.localScreen[0]+"vw;\n        top: "+this.data.localScreen[1]+"vh;\n        width: "+this.data.localScreen[2]+"vw; \n        height: "+this.data.localScreen[3]+"vh;\n      "},name:function(){var t=this.data.displayName.split("");return t.length>=9&&(t.length=8,t.push("...")),t.map(function(t,e){return{i:"mine-"+e,name:t}})}},pageLifetimes:{show:function(){var t=this;if(this.logger.log("component show"),!this.firstIn){var e=this.data.screen;if("custom"===this.data.template.layout&&(e=this.data.newCustomScreen),this.logger.log("on show screen: ",e),!e.length)return;e.forEach(function(e){if(e.roster&&e.roster.userId){var r=wx.createLivePlayerContext(e.roster.userId,t);r&&(r.play({complete:function(t){this.logger.log("player play: ",t)}}),r.resume({complete:function(t){this.logger.log("player resume: ",t)}}))}})}},hide:function(){var t=this;this.isHidePage={status:!0,time:Math.round((new Date).getTime())},this.logger.log("onhide page"),setTimeout(function(){t.pusher.start({complete:function(t){this.logger.log("pusher start: ",t)}}),t.pusher.resume({complete:function(t){this.logger.log("pusher resume: ",t)}})},2e3)}},lifetimes:{attached:function(){var t={layout:"auto",mode:"3-1",detail:[]};this.data.template&&"{}"!==JSON.stringify(this.data.template)&&(t=this.data.template),this.setData({template:t})},detached:function(){this.close()},ready:function(){this.firstIn=!0},show:function(){}},observers:{onHold:function(t){this.logger.log("onhold change: ",t),this.onCreateAutoLayout()}},created:function(){var t=Math.round((new Date).getTime()/1e3);this.logger=new n.default(!1,!1),this.userInfo=wx.getStorageSync("userInfo"),this.meetingInfo={},this.retryTimmer=0,this.streamTimmer=t,this.retryWS=0,this.retryCount=10,this.wsState=!1,this.heartbeat=null,this.isEitPage=!1,this.retryHeartbeat=null,this.retryNetwork=!1,this.pangTimer=null,this.pangTimeoutCount=0,this.pangEndTime=20,this.INVITE={},this.stream={type:"streamAssignment",frameRate:30,payloadType:"97",resolution:"640_360",bandwidth:1e3},this.roster=[],this.orderRoster=[],this.speaksInfo=[],this.isHidePage={status:!1,time:0},this.meetingControl={},this.pushers=[],this.cameraPostion=this.data.devicePosition,this.template=[],this.disconnected=!1,this.userList="",this.adjustAssignment={},this.streamRequestObj={},this.retryRoomsigTimmer=null,this.socketTask=null,this.isShowDeteced=!1,this.system=wx.getSystemInfoSync(),this.firstIn=!0,this.playerContexts={},this.pusher||(this.pusher=wx.createLivePusherContext("pusher")),wx.setKeepScreenOn({keepScreenOn:!0}),this.adjustResolution=(0,h.throttle)(this.onAdjustResolution,5e3),this.adjustBandwidth=(0,h.throttle)(this.onAdjustBandwidth,5e3),this.streamRequest=(0,h.throttle)(this.onStreamRequest,2e3),this.content={},this.fullScreenFlag={status:!1,context:null,userId:-1},this.contentSenderPid=0},methods:{onClickContent:function(t){this.postEvent("event","click",t)},close:function(t){this.logger.log("msg: ",t),this.isEitPage||(this.logger.log("onUnload page"),this.isEitPage=!0,this.onCloseMeeting(),this.resetTimmer(),this.adjustResolution=null,this.adjustBandwidth=null,this.streamRequest=null,this.socketTask=null)},onHoldScreen:function(t){this.setData({onHold:t}),this.pusher||(this.pusher=wx.createLivePusherContext("pusher")),t?this.pusher.pause():this.pusher.resume()},onFullScreenContent:function(t){var e=t.target.dataset.item,r=this.fullScreenFlag.status,s=e.roster.userId,n=(0,o.default)(this.data.screen),i=n.length;if(e.roster.isContent&&!r){this.fullScreenFlag={status:!0,userId:e.roster.userId,context:null};for(var a=0;a<i;a++){n[a].roster.userId!==s?-5!==n[a].position[0]&&(n[a].position=[-5,-5,5,5]):n[a].position=[0,0,100,100]}this.setData({screen:n,localScreen:[-5,-5,5,5]})}else this.exitFullScreen();this.postEvent("event","longpress","click content")},exitFullScreen:function(){this.fullScreenFlag.status=!1;for(var t=(0,o.default)(this.data.screen),e=t.length,r=d.template[this.data.mode],s=r.length,n=0;n<s;n++)for(var i=r[n],a=0;a<e;a++){var c=t[a];i.seat===c.seat&&(t[a].position=i.position)}this.setData({localScreen:this.data.isNullPerson?d.localPosition.max:d.localPosition.mini,screen:t})},resetTimmer:function(){this.pangTimer&&clearTimeout(this.pangTimer),this.heartbeat&&clearTimeout(this.heartbeat),this.operateBarTimmer&&clearTimeout(this.operateBarTimmer),this.retryHeartbeat&&clearTimeout(this.retryHeartbeat),this.retryRoomsigTimmer&&clearTimeout(this.retryRoomsigTimmer)},onSwitchAudioMute:function(){this.logger.log("on switch audio mute:",this.data.muted),this.data.muted?this.sendSocketMessage({type:"AUDIO_MUTE"}):this.sendSocketMessage({type:"AUDIO_UN_MUTE"})},onSwitchVideoMute:function(){var t=this;this.data.camera?(this.sendSocketMessage({type:"VIDEO_UN_MUTE"}),"back"===this.cameraPostion&&"android"===this.system.platform&&setTimeout(function(){t.pusher.switchCamera()},300)):this.sendSocketMessage({type:"VIDEO_MUTE"})},onCloseMeeting:function(){var t=this;this.logger.log("Close Meeting Page ...");var e={code:3999,reason:"关闭会议页面",success:function(){t.logger.log("ws断开连接成功")},fail:function(e){t.logger.log("ws断开连接失败!",e,"info")}};this.pusher&&this.pusher.stop({success:function(){t.logger.log("stop push live success!")},fail:function(){t.logger.log("stop push live fail!")}}),this.INVITE.callIndex&&this.sendSocketMessage({type:"STOP_CALL"});try{this.socketTask?this.socketTask.close(e):wx.closeSocket(e)}catch(t){this.logger.log("catch close ws err: ",t)}},postEvent:function(t,e,r){this.triggerEvent("onRoomEvent",{type:t,detail:e,message:r})},start:function(){this.userInfo=wx.getStorageSync("userInfo"),this.connectWS()},setDebug:function(t,e){this.logger.setDebug(t,e)},showComponent:function(){this.setData({display:!0})},switchCamera:function(){return this.cameraPostion="front"===this.cameraPostion?"back":"front",this.pusher.switchCamera(),this.cameraPostion},connectWS:function(){var t=this,e=wx.getStorageSync("domain").wsDomain||i.wsDomain,r=Math.round((new Date).getTime()/1e3),o=null,s=0;if(r-this.retryTimmer>3&&this.retryWS<this.retryCount){this.retryWS++,this.wsState=!1,this.retryTimmer=r;var n=!1,a=this.userInfo,c=a.userId,u=a.securityKey,h=this.INVITE.callIndex||"";this.socketTask=wx.connectSocket({url:e+"/websocket/wechat?userId="+c+"&securityKey="+u+"&callIndex="+h,success:function(e){t.logger.log("success connect ws",e),t.postEvent("callStatus","connected","websocket connect success"),n=!0},fail:function(e){n=!1,t.postEvent("callStatus","disconnected","websocket connect fail"),t.logger.log("fail connect ws: ",e)},complete:function(e){t.logger.log("complete connect ws: ",e)}}),o=setInterval(function(){s++,t.socketTask&&n&&(t.initWSHandle(),clearInterval(o),o=null),s>200&&(clearInterval(o),o=null)},20)}},initWSHandle:function(){this.wsState=!0,clearTimeout(this.retryHeartbeat),this.retryHeartbeat=null,this.onCloseWS(),this.onSuccessConnectWS(),this.onListenerMessage(),this.sendWSHeartbeat()},onListenerMessage:function(){var t=this;this.socketTask.onMessage(function(e){t.retryWS=0,"PONG"===e.data?clearTimeout(t.pangTimer):t.handleMessage(e.data)})},onSuccessConnectWS:function(){var t=this;this.socketTask.onOpen(function(){t.logger.log("ws连接已建立"),t.wsState=!0,t.retryWS=0,t.enterRoom(),t.sendStartCall()})},onCloseWS:function(){var t=this;this.socketTask.onClose(function(e){t.logger.log("WS 连接关闭",e,"warn"),t.wsState=!1,clearInterval(t.heartbeat),t.heartbeat=null,t.retryWS>=t.retryCount&&!t.isEitPage&&(t.isEitPage=!0,t.exitRoom("当前与服务器连接已断开，请您退出重新尝试")),t.isEitPage||3999===e.code||t.timeoutRetryWS()})},enterRoom:function(){this.INVITE.callIndex&&this.retryNetwork&&this.getRoomSig(),this.INVITE.callIndex&&(this.logger.log("断线重连，发送enter_room消息","","warn"),this.sendSocketMessage({type:"ENTER_ROOM"})),this.INVITE.callIndex&&this.retryNetwork&&(this.sendSocketMessage({type:"rePush"}),this.retryNetwork=!1)},sendStartCall:function(){this.meetingInfo=wx.getStorageSync("meeting");var t=this.meetingInfo,e=t.number,r=t.password,o=t.displayName||wx.getStorageSync("userInfo").displayName;this.INVITE.callIndex||(this.sendSocketMessage({type:"START_CALL",displayName:o,conferenceNumber:e,pwd:r,wechatVersion:"v2"},!1),this.setData({displayName:o}))},sendWSHeartbeat:function(){var t=this;clearInterval(this.heartbeat),this.heartbeat=setInterval(function(){t.sendWsPING()},2e4)},sendWsPING:function(){this.wsState&&(this.socketTask.send({data:"PING"}),this.createTimeout())},createTimeout:function(){var t=this;this.pangTimer=setTimeout(function(){if(t.pangTimeoutCount+=1,t.pangTimeoutCount>=t.pangEndTime)return clearInterval(t.heartbeat),clearTimeout(t.pangTimer),void t.handleCloseSocket();t.createTimeout()},1e3)},handleCloseSocket:function(){var t=this;if(this.wsState&&this.socketTask)try{this.socketTask.close({success:function(){t.logger.log("ws连接异常，断开成功，需要重连","","warn")},fail:function(e){t.logger.log("ws连接异常，断开失败，需要重连",e,"warn")},complete:function(){t.wsState=!1,t.retryWS>=t.retryCount||t.connectWS()}})}catch(t){this.wsState=!1,this.logger.log("catch ws连接异常",t,"warn")}},onStreamRequest:function(){var t=this.streamRequestObj.streams[0],e=t.bandwidth,r=void 0===e?0:e,o=t.decCaps,s=t.delete,n=~~r>1e3?1e3:r,i=o[0].resolution,a=~~i.split("_")[1],c=this.adjustAssignment.resolution;a>360&&(i=c||"640_360"),s||(this.stream={type:"streamAssignment",frameRate:30,payloadType:"97",resolution:i,bandwidth:n},this.onSendStreamAssignment())},handleMessage:function(t){var e=JSON.parse(t);switch(e.type){case"CONNECTED":this.logger.log("接收到CONNECTED消息: ",e,"info"),this.INVITE=e,this.showComponent(),this.postEvent("callStatus","connected",e),this.getRoomSig(),this.firstIn&&(this.onSwitchAudioMute(),this.onSwitchVideoMute(),this.firstIn=!1);break;case"START_CALL":this.logger.log("接收START_CALL消息: ",e,"info"),this.INVITE=e,this.postEvent("callStatus","connected",e);break;case"DIS_CONNECTED":this.logger.log("接收DIS_CONNECTED消息: ",e,"info"),this.disconnected||(this.disconnected=!0,this.postEvent("callStatus","disconnected",e));break;case"confMgmtReport":this.logger.log("接收会控confMgmtReport消息: ",e,"info"),this.onMeetingControlMessage(e),this.postEvent("confMgmt",e,"会控confMgmtReport消息");break;case"streamRequest":this.logger.log("接收streamRequest消息: ",e,"info"),this.streamRequestObj=e,this.streamRequest&&this.streamRequest();break;case"roster":this.logger.log("接收roster消息: ",e,"info"),this.contentSenderPid=e.contentSenderPid||0,this.roster=(0,o.default)(e.rosterV),this.onCreateLayout(),this.postEvent("roster",e,"roster详细数据");break;case"speakersInfo":this.logger.log("接收speakerInfo消息: ",e,"info"),this.speaksInfo=e.speakers;var r=this.speaksInfo.some(function(t){return t.isActiveSpeaker}),s=this.data.template.layout;this.meetingControl.chairmanUri||"auto"!==s||(r?this.onCreateLayout():this.onCreateAutoLayout()),this.postEvent("speakersInfo",e.speakers,"speaker info");break;case"MEDIA_ONHOLD":var n=!!e.isOnHold;this.logger.log("接收Onhold消息: ",e,"info"),this.onHoldScreen(n),this.postEvent("onHold",e.isOnHold,"onhold");break;default:this.logger.log("接收到其他ws消息",e,"info")}},updateCustomScreenStatus:function(t){for(var e=(0,o.default)(this.data.customScreen),r=e.length,s=0;s<r;s++){var n=e[s];if(n.roster){var i=n.roster,a=i.isContent;if(i.callNumber+(a?"1":"0")===t){var c;this.setData(((c={})["customScreen["+s+"].status"]="start",c));break}}}},updateScreenStatus:function(t){for(var e=this.data.screen.concat(),r=e.length,o=0;o<r;o++){var s=e[o],n=s.roster.isContent?"1":"0";if(s.roster.userId+n===t){var i;this.setData(((i={})["screen["+o+"].status"]="start",i));break}}},onPlay:function(t){var e=t.detail.code,r=t.target.id;switch(e){case 2004:"auto"===this.data.template.layout?this.updateScreenStatus(r):this.updateCustomScreenStatus(r),this.logger.log("onPlay "+e+" id: ",r);break;case 2015:this.showToast("当前视频播放出现卡顿");break;case 2104:this.showToast("网络来包不稳,可能是下行带宽不足");break;case 2017:this.showToast("当前视频播放出现卡顿")}},onPush:function(t){var e=void 0;switch(e=t.detail?t.detail.code:t){case 1006:this.adjustAssignment={1006:t},this.adjustBandwidth&&this.adjustBandwidth();break;case 1005:this.adjustAssignment={1005:t},this.adjustResolution&&this.adjustResolution();break;case-1301:this.exitRoom("打开摄像头失败，请退出删除小程序重新进入");break;case-1302:this.exitRoom("打开麦克风失败，请退出删除小程序重新进入");break;case-1307:this.exitRoom("推流连接断开"),this.logger.log("onPush 推流连接断开: ",e,"warn");break;case 5e3:this.logger.log("onPush 推流挂断: ",e,"warn");var r=Math.round((new Date).getTime());this.isHidePage.status&&r-this.isHidePage.time<=1e3&&(this.onCloseMeeting(),this.exitRoom());break;case 1102:this.logger.log("onPush tx重连: ",{code:e,message:t.detail.message||""},"warn");break;case 1019:this.logger.log("onPush 退出房间: ",e,"warn"),this.exitRoom();break;case 1020:var o=t.detail.message;o&&o!==this.userList&&(this.userList=o,this.onWebRTCUserListPush(o));break;case 1021:this.logger.log("网络发生变化,请重新进会",e,"warn"),this.showToast("网络发生变化，重新请求数据..."),this.retryNetwork=!0}this.postEvent("roomChange",t.detail,"live-pusher status change message.")},onAdjustBandwidth:function(){var t=~~(this.adjustAssignment[1006].detail.message||"").replace(/[^0-9]/gi,"")||this.stream.bandwidth;t=t>1e3?1e3:t;var e=Object.assign({},this.stream,{bandwidth:t});this.stream=e,this.adjustAssignment={bandwidth:t},this.onSendStreamAssignment(1006)},onAdjustResolution:function(){var t=(this.adjustAssignment[1005].detail.message||"").split(":"),e=t[t.length-1].split("*"),r=~~e[0]>360?"640_360":e[1]+"_"+e[0];this.adjustAssignment={resolution:r};var o=Object.assign({},this.stream,{resolution:r||this.stream.resolution});this.stream=o,this.onSendStreamAssignment(1005)},onCreateLayout:function(){var t=this,e=this.data.template.layout;"auto"===e&&(this.onCreateAutoLayout(),setTimeout(function(){t.onCreateAutoStreams()},1))},onCreateCustomLayout:function(){var t=(0,o.default)(this.roster),e=this.INVITE.userId;this.logger.log("-------------custom layout------------"),this.logger.log("create custom layout before data: ",{rosters:t,myUserId:e,customScreen:(0,o.default)(this.data.customScreen),pushers:(0,o.default)(this.pushers)},"debug"),this.logger.log("-------------custom layout------------");var r=new u.default(t,this),s=r.getScreen(),n=r.getContent();this.logger.log("create custom layout screen: ",s),this.logger.log("get roster content info: ",n),this.rewriteCustomScreenInfo(s),this.postEvent("content",n,"receive content"),r=null,this.onCreateCustomStreams()},onCreateCustomStreams:function(){for(var t=[],e=this.data.customScreen.concat(),r=e.length,o=0;o<r;o++){var s=e[o],n=s.quality||"normal",i=s&&s.roster&&s.roster.userId;s&&s.roster&&s.roster.audioTxMute&&s.roster.videoTxMute||this.userInfo.callNumber!==s.callNumber&&i&&t.push({pid:s.roster?s.roster.pid:"",resolution:l.videoQuality[n],frameRate:"30",bandwidth:l.videoBandwidth[n],priority:0})}this.logger.log("send custom layout: ",t,"info"),this.sendSocketMessage({type:"CUSTOM_LAYOUT",streams:t})},onCreateAutoStreams:function(){for(var t=this.data.screen.concat(),e=t.length,r=[],o=0;o<e;o++){var s=t[o];if(1===s.seat&&s.roster.isContent){var n=this.getStreamConfig(2,s.roster.pid);r.push(n)}else if(!s.roster.audioTxMute||!s.roster.videoTxMute)if(1===s.seat&&s.roster.userId){var i=this.getStreamConfig(1,s.roster.pid);r.push(i)}else if(s.roster.userId){var a=this.getStreamConfig(-1,s.roster.pid);r.push(a)}}this.sendSocketMessage({type:"CUSTOM_LAYOUT",streams:r})},getStreamConfig:function(t,e){return 1!==t&&2!==t?{pid:e,resolution:"320_180",frameRate:"30",bandwidth:256,priority:0}:2===t?{pid:e,resolution:"1280_720",frameRate:"15",bandwidth:1e3,priority:0}:{pid:e,resolution:"640_360",frameRate:"30",bandwidth:1e3,priority:0}},onCreateAutoLayout:function(){var t=this.roster.concat(),e=this.speaksInfo.concat(),r=this.INVITE.userId,o=this.meetingControl.chairmanUri,s=this.isNullPersonInRoster(t,r),n=this.data.screen.concat();if(this.logger.log("-------------start------------","","debug"),this.logger.log("",{rosters:t,myUserId:r,speakers:e,chairmanUri:o,isNullPerson:s,screen:n},"debug"),this.logger.log("-------------end------------","","debug"),!s){var i=new c.default(t,this),a=i.getScreen(),u=i.getContentItem();this.rewriteScreenInfo(a),this.setData({isNullPerson:!1,localScreen:d.localPosition.mini}),(!this.content.userId&&u.userId||this.content.userId&&u.userId&&u.userId!==this.content.userId)&&this.postEvent("content",u,"receive content"),this.content=u,!u.userId&&this.fullScreenFlag.status&&this.exitFullScreen(),i=null}},isNullPersonInRoster:function(t,e){if(t.length<=0||1===t.length&&t[0].userId===e){var r=d.template[this.data.mode]||[],o=JSON.parse(JSON.stringify(r));return this.setData({screen:o,isNullPerson:!0,localScreen:d.localPosition.max,content:{}}),this.fullScreenFlag.status&&this.exitFullScreen(),!0}return!1},onSendStreamAssignment:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.logger.log("onPush send streamAssignment "+t+" :",this.stream,"log"),this.sendSocketMessage(this.stream)},throttlingStream:function(){var t=Math.round((new Date).getTime()/1e3);return t-this.streamTimmer>5&&(this.streamTimmer=t,!0)},onMeetingControlMessage:function(t){var e=t.muteOperation,r=t.disableMute,o=t.chairmanUri,s=void 0===o?"":o,n=t.role,i=this.meetingControl.chairmanUri||"",a=this.data.template.layout;if(e){var c=!("mute"!==e);this.setData({muted:c,disableMute:r})}else this.setData({disableMute:r});this.meetingControl={muteOperation:e,chairmanUri:s,role:n},i!==s&&this.roster.length>0&&"auto"===a&&this.onCreateLayout()},onWebRTCUserListPush:function(t){var e=JSON.parse(t),r=this.data.template.layout;if(e){var o=e.userlist||[];this.pushers=o,this.logger.log("pushers list: ",this.pushers),"custom"===r&&(this.rewriteCustomScreenInfo(),this.startPlayer("custom")),"auto"===r&&(this.rewriteScreenInfo(),this.startPlayer("auto"))}},startPlayer:function(t){var e=this;setTimeout(function(){("auto"===t?e.data.screen:e.data.customScreen).forEach(function(t){if(t&&t.roster&&t.roster.userId){var r=t.roster,o=r.userId+(r.isContent?"1":"0"),s=e.playerContexts[o];s?(s.stop(),s.play(),e.logger.log("live player play successfully")):(e.playerContexts[o]=wx.createLivePlayerContext(o),e.playerContexts[o].stop(),e.playerContexts[o].play(),e.logger.log("new live player play successfully"))}})},1)},rewriteCustomScreenInfo:function(t){var e=this.pushers,r=e.length,s=t?(0,o.default)(t):(0,o.default)(this.data.customScreen),n=s.length;this.logger.log("this pushers: ",this.pushers);for(var i=0;i<n;i++)for(var a=s[i],c=0;c<r;c++){var u=e[c];if(a.roster&&a.roster.userId===u.userid){s[i].playUrl=u.playurl;break}}this.logger.log("custom layout new screen: ",s,"info"),this.setData({customScreen:s})},rewriteScreenInfo:function(t){for(var e=this.pushers.concat(),r=e.length,s=t?(0,o.default)(t):(0,o.default)(this.data.screen),n=s.length,i=0;i<n;i++)for(var a=s[i],c=0;c<r;c++){var u=e[c];if(a.roster.userId===u.userid){var h=Object.assign({},a,{playUrl:u.playurl});s[i]=h}}this.logger.log("new screen: ",s,"info"),this.setData({screen:s})},timeoutRetryWS:function(){var t=this,e=this;this.retryHeartbeat=setTimeout(function(){e.wsState||t.isEitPage||(e.logger.log("异常断开，正在重连：",e.retryWS,"warn"),e.connectWS(),e.timeoutRetryWS())},3e3)},exitRoom:function(t){this.postEvent("roomExit","",t),t?(this.logger&&this.logger.log("on exit room: ",t),wx.showModal({title:"提示",content:t,showCancel:!1,confirmText:"退出会议",confirmColor:"#44b5ff",success:function(){wx.navigateBack({delta:1})}})):(this.logger.log("on exit room ..."),wx.navigateBack({delta:1}))},onPusherError:function(t){this.logger.log("live pusher on error: ",t,"warn");try{var e=t.detail,r=e.errCode,o=void 0===r?0:r,s=e.errMsg,n=void 0===s?"":s;10001===o?(this.logger.log("pusher permission error: ",o,"warn"),this.postEvent("permissionFail","camera",n),this.detectAuthorizeModel()):10002===o?(this.logger.log("pusher permission error: ",o,"warn"),this.postEvent("permissionFail","microphone",n),this.detectAuthorizeModel()):(this.logger.log("pusher other error: ",o,"warn"),this.exitRoom("授权错误，请手动删除微信小程序，重新进入"))}catch(t){this.logger.log("pusher catch error: ",t)}},detectAuthorizeModel:function(){var t=this;this.isShowDeteced||(this.isShowDeteced=!0,wx.showModal({title:"权限提示",content:"请开启“麦克风”和“摄像头”权限才可以进行音视频通话！",showCancel:!0,cancelText:"取消",cancelColor:"#666666",confirmText:"去设置",confirmColor:"#44b5ff",success:function(e){e.confirm?t.detectAuthorize():e.cancel&&t.exitRoom()}}))},detectAuthorize:function(){var t=this;try{wx.openSetting({success:function(e){var r=e.authSetting["scope.camera"],o=e.authSetting["scope.record"];t.isShowDeteced=!1,r&&o?(t.logger.log("pusher set permission success: ",e.authSetting,"info"),t.exitRoom("授权成功，请重新入会")):(t.logger.log("pusher set permission: ",e.authSetting,"warn"),t.detectAuthorizeModel())},fail:function(e){t.logger.log("pusher set permission fail: ",e,"warn"),t.exitRoom("授权错误，请重新入会")}})}catch(t){this.logger.log("pusher set permission catch error: ",t,"warn")}},startPushLive:function(){var t=this;this.pusher||(this.pusher=wx.createLivePusherContext("pusher")),this.pusher.start({success:function(){t.logger.log("start push success")},fail:function(e){t.logger.log("start push failed",e,"warn")}})},getRoomSig:function(){var t,e=(t=s.default.mark(function t(){var e,r,o,n,a,c,u,h,l,d=this;return s.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=this.INVITE,r=e.userId,o=e.userSecret,n=e.roomid,a="https://official.opensso.tencent-cloud.com/v4/openim/jsonvideoapp?sdkappid="+o.sdkAppId+"&identifier="+r+"&usersig="+o.usersig+"&random=9999&contenttype=json",t.next=4,(0,i.request)({url:a,method:"POST",data:{ReqHead:{Cmd:1,SeqNo:1,BusType:7,GroupId:n},ReqBody:{PrivMapEncrypt:o.privateMapKey,PrivMap:255,TerminalType:2,FromType:3}},isPureUrl:!0});case 4:200===(c=t.sent).statusCode?(u=c.data,h=JSON.stringify(u.RspBody),l="room://cloud.tencent.com?sdkappid="+o.sdkAppId+"&roomid="+n+"&userid="+r+"&roomsig="+encodeURIComponent(h),this.setData({pushUrl:l}),this.logger.log("pushUrl: ",l,"info"),this.startPushLive(),this.retryRoomsigTimmer&&clearTimeout(this.retryRoomsigTimmer),this.retryRoomsigTimmer=null):this.retryRoomsigTimmer=setTimeout(function(){clearTimeout(d.retryRoomsigTimmer),d.retryRoomsigTimmer=null,d.getRoomSig()},2e3);case 6:case"end":return t.stop()}},t,this)}),function(){var e=t.apply(this,arguments);return new Promise(function(t,r){return function o(s,n){try{var i=e[s](n),a=i.value}catch(t){return void r(t)}if(!i.done)return Promise.resolve(a).then(function(t){o("next",t)},function(t){o("throw",t)});t(a)}("next")})});return function(){return e.apply(this,arguments)}}(),sendSocketMessage:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],o=this.meetingInfo.number,s={callIndex:this.INVITE.callIndex||-1,conferenceNumber:o,meetingId:this.INVITE.meetingId||-1},n=r?Object.assign({},e,s):e;this.logger.log("发送WS信息:",n,"info"),this.socketTask&&this.socketTask.send({data:JSON.stringify(n),success:function(){t.logger.log("success send meeting message: ")},fail:function(e){t.logger.log("fail send meeting message: ",e)}})},showToast:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"none",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2e3;wx.showToast({title:t,icon:e,duration:r})}}})},function(t,e){t.exports=function(t){return t.webpackPolyfill||(t.deprecate=function(){},t.paths=[],t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),t.webpackPolyfill=1),t}},function(t,e,r){"use strict";e.__esModule=!0,e.request=e.requestDomain=e.wsDomain=void 0,r(2);var o,s=r(3),n=(o=s)&&o.__esModule?o:{default:o};e.wsDomain="wss://prdtxlive.xylink.com";var i=e.requestDomain="https://prdtxlive.xylink.com",a=wx.getSystemInfoSync(),c=a.brand,u=a.model,h=a.system,l=new n.default(!0,!0,!1);e.request=function(t){var e=Math.ceil(1e3*Math.random()),r=wx.getStorageSync("domain").requestDomain||i,o=t.isAddDomain,s=void 0===o||o,n=t.isPureUrl,a=void 0!==n&&n,d=t.data,g=void 0===d?{}:d,f=t.body,p=void 0===f?{}:f,m=t.isAddSK,v=void 0!==m&&m,y=Object.assign({},g,p),S=t.method||"GET",w=Object.assign({},{"content-type":"application/json","n-ua":"PL=mp-sdk&AV=1043&DR=&RL=&MF="+c+"&MO="+u+"&OS="+h+"&API=&LCLO=&LCLA=&CK="},t.header),I=t.url;if(v){var b=wx.getStorageSync("userInfo"),x=b.securityKey,T=void 0===x?"":x,k=b.appId;I=I+"?securityKey="+T+"&appId="+(void 0===k?"":k)}return s&&(I=r+"/api/rest/v1/wx/"+I),a&&(I=t.url),l.log("ajax request:",e+"  "+S+"  "+I),l.log("----------"),new Promise(function(r,o){t.noLoading||wx.showLoading({mask:!0,title:"处理中"}),wx.request({url:I,data:y,header:w,method:S,success:function(t){l.log("ajax "+e+" response2:",t),r(t)},fail:function(t){l.log("ajax "+e+" response error:",t),o(t)},complete:function(){t.noLoading||wx.hideLoading()}})})}},function(t,e,r){"use strict";e.__esModule=!0;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};e.computedBehavior=Behavior({lifetimes:{created:function(){this._computedCache={},this._originalSetData=this.setData,this.setData=this._setData,this._doingSetData=!1}},definitionFilter:function(t){var e=t.computed||{},r=Object.keys(e),s=function(t){for(var o={},s=t._computedCache||t.data,n=0,i=r.length;n<i;n++){var a=r[n],c=e[a];if("function"==typeof c){var u=c.call(t);s[a]!==u&&(o[a]=u,s[a]=u)}}return o};!function(){t.data=t.data||{};var e=t.data,r=t.properties,n=Object.prototype.hasOwnProperty;r&&Object.keys(r).forEach(function(t){var i=r[t],a=void 0;null===i||i===Number||i===String||i===Boolean||i===Object||i===Array?r[t]={type:i}:"object"===(void 0===i?"undefined":o(i))&&(n.call(i,"value")&&(e[t]=i.value),n.call(i,"observer")&&"function"==typeof i.observer&&(a=i.observer)),r[t].observer=function(){var t=this._originalSetData;if(this._doingSetData)console.warn("can't call setData in computed getter function!");else{this._doingSetData=!0;var e=s(this);t.call(this,e),this._doingSetData=!1;for(var r=arguments.length,o=Array(r),n=0;n<r;n++)o[n]=arguments[n];a&&a.apply(this,o)}}}),s(t)}(),t.methods=t.methods||{},t.methods._setData=function(t,r){var o=this._originalSetData;if(this._doingSetData)console.warn("can't call setData in computed getter function!");else{this._doingSetData=!0;for(var n=Object.keys(t),i=0,a=n.length;i<a;i++){var c=n[i];e[c]&&delete t[c]}o.call(this,t,r);var u=s(this);o.call(this,u),this._doingSetData=!1}}}})},function(t,e,r){"use strict";e.__esModule=!0;var o=r(0);var s=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var s=r.INVITE,n=r.speaksInfo,i=void 0===n?[]:n,a=r.meetingControl,c=r.logger,u=r.contentSenderPid,h=void 0===u?0:u,l=r.data,d=l.mode,g=void 0===d?"1+3":d,f=l.onHold;this.screen=r.data.screen||[],this.onHold=f,this.rosters=e,this.myUserId=s.userId,this.speakers=i,this.chairmanUri=a.chairmanUri,this.newScreen=[],this.contentSenderPid=h,this.cacheNewScreen=[],this.logger=c,this.content={},this.orderRoster=[],this.speakerInfo=this.getASP(),this.initScreen=o.template[g],this.setOrderRosters(),this.createNewScreen(),this.newScreenLen=this.newScreen.length}return t.prototype.getScreen=function(){return this.setScreeen(),this.logger&&this.logger.log("Screen class screen: ",this.screen.concat()),this.screen},t.prototype.getContentItem=function(){return this.content},t.prototype.getOrderRoster=function(){return this.orderRoster},t.prototype.getNewScreen=function(){return this.newScreen},t.prototype.setScreeen=function(){this.orderRoster.length&&this.newScreenLen?(this.updateScreen(),this.onHold&&this.setHideScreen(),this.clearUselessScreen()):this.screen=this.initScreen.concat()},t.prototype.setHideScreen=function(){for(var t=this.screen.length,e=0;e<t;e++){var r=this.screen[e];this.screen[e]=Object.assign({},r,{hidePosition:o.initHidePosition})}},t.prototype.clearUselessScreen=function(){for(var t=this.screen.length,e=0,r=this.initScreen.length,s=this.newScreenLen>=r?this.newScreenLen:r,n=0;n<t;n++){var i=this.screen[n];if(i&&i.deal||(this.screen[n]={seat:i.seat,status:i.status,position:i.position||o.initHidePosition,roster:{},playUrl:""}),(i.deal||i.seat<=r)&&(delete this.screen[n].deal,++e>=s)){this.screen.length=n+1;break}}},t.prototype.updateScreen=function(){for(var t=this.newScreen.length,e=0;e<t;e++){var r=this.newScreen[e],o=e+1,s=this.getIndexInScreenByUserid(r.roster,"old");-1===s?this.updateScreenUseIndex(o,r):this.updateScreenUseItem(s,o,r)}},t.prototype.updateScreenUseIndex=function(t,e){var r=this.screen.length,o=this.getIndexInScreenBySeat(t,"old");o=-1===o?r:o;var s=this.screen[o];if(s&&s.roster.userId){var n=s.roster;if(-1===this.getIndexInScreenByUserid(n,"new"))this.updateRoster(o,e,t);else{var i=this.getNewIndexInScreenByUserid();this.exchangePosition(i,o,s),this.updateRoster(i,e,t)}}else this.updateRoster(o,e,t)},t.prototype.updateScreenUseItem=function(t,e,r){if(e===this.screen[t].seat)this.updateRoster(t,r,e);else{var o=this.getIndexInScreenBySeat(e,"old");if(-1!==o)this.exchangePosition(t,o,r.roster),this.screen[t].deal=!0;else{var s=this.getNewIndexInScreenByUserid(e);this.exchangePosition(t,s,r.roster),this.updateRoster(t,r,e)}}},t.prototype.updateRoster=function(t,e,r){this.screen[t]?(this.screen[t].roster=e.roster,this.screen[t].deal=!0,this.screen[t].seat=r):this.screen[t]={roster:e.roster,deal:!0,position:o.initHidePosition,playUrl:"",seat:r,status:"start"}},t.prototype.exchangePosition=function(t,e,r){var o=this.screen[t],s=o.seat,n=o.position,i=this.screen[e],a=i.seat,c=i.position;this.screen[e].seat=s,this.screen[e].position=n,this.screen[t].seat=a,this.screen[t].position=c,this.screen[t].roster=r},t.prototype.getNewIndexInScreenByUserid=function(t){for(var e=this.screen.length,r=this.initScreen.length,s=t||e+1,n=-1,i=0;i<e;i++){var a=this.screen[i];if(a.seat>r&&(!a||a&&!a.roster.userId)){this.screen[i].seat=s,n=i;break}}return-1===n&&(this.screen.push({seat:s,position:o.initHidePosition,roster:{},status:"start",playUrl:""}),n=this.screen.length-1),n},t.prototype.getIndexInScreenByUserid=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1],r=t.userId,o="old"===e?this.screen:this.newScreen,s=o.length,n=-1;if(!r)return n;for(var i=0;i<s;i++){var a=o[i];if(a&&a.roster.userId===r){n=i;break}}return n},t.prototype.getIndexInScreenBySeat=function(t,e){for(var r="old"===e?this.screen:this.newScreen,o=r.length,s=-1,n=0;n<o;n++){var i=r[n];if(i&&i.seat===t){s=n;break}}return s},t.prototype.createNewScreen=function(){for(var t=this.orderRoster.length,e=this.initScreen.length,r=0;r<t;r++){var o=this.orderRoster[r];if(0!==r){if(!o.audioTxMute||e>r)this.setItemInNewScreen(-1,o);else if(o.audioTxMute)break}else this.setItemInNewScreen(1,o)}console.log("newScreen: ",this.newScreen)},t.prototype.setItemInNewScreen=function(t,e){this.newScreen.push({seat:t,roster:e})},t.prototype.getASP=function(){for(var t=this.speakers.length,e=null,r=0;r<t;r++){var o=this.speakers[r];if(o.isActiveSpeaker){e=o;break}}return e},t.prototype.setOrderRosters=function(){for(var t=this.rosters,e=t.length,r={content:[],chairman:[],activeSpeaker:[],audioVideoUnmute:[],audioUnmute:[],videoUnmute:[],audioVideoMute:[]},o=!0,s=0;s<e;s++){var n=t[s],i=this.chairmanUri&&(this.chairmanUri===n.userId||"h323"===n.deviceType&&this.chairmanUri===n.callUri);n.isActiveSpeaker=!1,this.onHold?n.muted=!0:n.muted=!1,this.myUserId===n.userId||"h323"===n.deviceType&&this.myUserId===n.callUri||"record"===n.deviceType||n.isContent&&n.pid!==this.contentSenderPid||(n.isContent&&n.pid===this.contentSenderPid?(this.content=n,o=!1,r.content.push(n)):i?(o=!1,r.chairman.push(n)):this.speakerInfo&&this.speakerInfo.userId===n.userId?(n.isActiveSpeaker=!0,o=!1,r.activeSpeaker.push(n)):n.audioTxMute||n.videoTxMute?n.audioTxMute||!n.videoTxMute?!n.audioTxMute||n.videoTxMute?n.audioTxMute&&n.videoTxMute&&r.audioVideoMute.push(n):r.videoUnmute.push(n):r.audioUnmute.push(n):r.audioVideoUnmute.push(n))}var a=[];for(var c in r)({}).hasOwnProperty.call(r,c)&&(a=a.concat(r[c]));this.setOriMasterScreenItem(a,o)},t.prototype.setOriMasterScreenItem=function(t,e){var r=this.getIndexInScreenBySeat(1,"old"),o=(this.screen[r]&&this.screen[r].roster||{}).userId||"";if(e){var s=this.getIndexInRoster(t,o);if(-1!==s){var n=t[s];t.splice(s,1),t.unshift(n)}}this.orderRoster=t},t.prototype.getIndexInRoster=function(t,e){for(var r=t.length,o=-1,s=0;s<r;s++){if(t[s].userId===e){o=s;break}}return o},t}();e.default=s},function(t,e,r){"use strict";e.__esModule=!0;var o,s=r(1),n=(o=s)&&o.__esModule?o:{default:o},i=r(0);var a=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var o=r.INVITE,s=r.speaksInfo,i=void 0===s?[]:s,a=r.meetingControl,c=r.logger,u=r.data.onHold;this.initScreen=r.data.template.detail||[],this.customScreen=[],this.onHold=u,this.rosters=(0,n.default)(e)||[],this.myUserId=o.userId,this.speakers=i,this.chairmanUri=a.chairmanUri,this.logger=c,this.content={},this.orderRosters=[],this.setOrderRosters()}return t.prototype.getScreen=function(){return this.setScreeen(),this.logger&&this.logger.log("class getCustomScreen: ",this.customScreen),this.customScreen},t.prototype.getContent=function(){return this.content},t.prototype.setScreeen=function(){this.customScreen=(0,n.default)(this.initScreen),console.log("class get clone temaplte detail: ",this.customScreen),this.updateScreen(),this.setOtherScreen()},t.prototype.setOtherScreen=function(){for(var t=(0,n.default)(this.getAudioUnmuteRosters()),e=(0,n.default)(this.customScreen),r=[],o=t.length,s=function(o){var s=t[o];e.every(function(t){return t.callNumber!==s.callNumber||t.isContent})&&r.push({callNumber:s.callNumber,name:s.displayName,position:i.initHidePosition,roster:s})},a=0;a<o;a++)s(a);this.logger.log("other custom layout new screen: ",r,"info"),this.customScreen=this.customScreen.concat(r)},t.prototype.setOrderRosters=function(){for(var t=(0,n.default)(this.rosters),e=t.length,r={content:[],chairman:[],activeSpeaker:[],audioVideoUnmute:[],audioUnmute:[],videoUnmute:[],audioVideoMute:[]},o=0;o<e;o++){var s=t[o],i=this.chairmanUri&&(this.chairmanUri===s.userId||"h323"===s.deviceType&&this.chairmanUri===s.callUri);s.isActiveSpeaker=!1,this.onHold?s.muted=!0:s.muted=!1,this.myUserId===s.userId||"h323"===s.deviceType&&this.myUserId===s.callUri||"record"===s.deviceType||(s.isContent?(this.content=s,r.content.push(s)):i?r.chairman.push(s):s.audioTxMute||s.videoTxMute?s.audioTxMute||!s.videoTxMute?!s.audioTxMute||s.videoTxMute?s.audioTxMute&&s.videoTxMute&&r.audioVideoMute.push(s):r.videoUnmute.push(s):r.audioUnmute.push(s):r.audioVideoUnmute.push(s))}var a=[];for(var c in r)({}).hasOwnProperty.call(r,c)&&(a=a.concat(r[c]));this.orderRosters=a},t.prototype.getAudioUnmuteRosters=function(){return this.orderRosters.filter(function(t){return!t.audioTxMute})},t.prototype.updateScreen=function(){for(var t=(0,n.default)(this.rosters),e=(0,n.default)(this.customScreen),r=e.length,o=0;o<r;o++){var s=e[o],i=this.getIndexInRosters(t,s);s&&(e[o].roster=t[i])}this.logger.log("class custom layout new screen: ",e),this.customScreen=e},t.prototype.isClearContentItem=function(t){return t&&t.isContent&&!t.roster},t.prototype.getIndexInRosters=function(t,e){var r=-1,o=e.callNumber,s=e.isContent;if(!o)return r;if(e&&s){for(var n=0;n<t.length;n++)if(t[n].callNumber===o&&t[n].isContent){r=n;break}}else for(var i=0;i<t.length;i++)if(t[i].callNumber===o&&!t[i].isContent){r=i;break}return r},t}();e.default=a},function(t,e,r){"use strict";e.__esModule=!0;var o=e.formatNumber=function(t){var e=t.toString();return e[1]?e:"0"+e};e.formatTime=function(t){var e=t.getFullYear(),r=t.getMonth()+1,s=t.getDate(),n=t.getHours(),i=t.getMinutes(),a=t.getSeconds();return[e,r,s].map(o).join("/")+" "+[n,i,a].map(o).join(":")},e.secondToDate=function(t){return(Math.floor(t/3600)<10?"0"+Math.floor(t/3600):Math.floor(t/3600))+":"+(Math.floor(t/60%60)<10?"0"+Math.floor(t/60%60):Math.floor(t/60%60))+":"+(Math.floor(t%60)<10?"0"+Math.floor(t%60):Math.floor(t%60))},e.debounce=function(t,e,r){var o=null,s=null;return function(){for(var n=arguments.length,i=Array(n),a=0;a<n;a++)i[a]=arguments[a];var c=+new Date,u=this;clearTimeout(o),s||(s=c),c-s>=r?(t.apply(u,i),s=c):o=setTimeout(function(){t.apply(u,i)},e)}},e.throttle=function(t,e){var r=0;return function(){var o=+new Date;if(o-r>e||!r){for(var s=arguments.length,n=Array(s),i=0;i<s;i++)n[i]=arguments[i];t.apply(this,n),r=o}}}},function(t,e,r){"use strict";e.__esModule=!0;e.videoQuality={normal:"320_180",high:"640_360",hd:"1280_720"},e.videoBandwidth={normal:256,high:900,hd:1200}}]);